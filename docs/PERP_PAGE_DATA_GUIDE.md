# 合约交易页面 - 数据与功能完整说明

> 这份文档详细说明了合约交易页面上每一个数据的来源和每一个功能的作用

---

## 目录

1. [页面整体布局](#页面整体布局)
2. [顶部信息栏](#一顶部信息栏)
3. [左侧订单簿](#二左侧订单簿)
4. [中间K线图](#三中间k线图)
5. [底部标签页](#四底部标签页)
6. [右侧下单面板](#五右侧下单面板)
7. [账户余额弹窗](#六账户余额弹窗)
8. [数据更新方式汇总](#七数据更新方式汇总)
9. [后端接口清单](#八后端接口清单)

---

## 页面整体布局

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         顶部信息栏                                        │
│  代币名称 | 价格 | 涨跌 | 市值 | 资金费率 | 持仓量 | 成交量 | 账户余额      │
├──────────┬───────────────────────────────────────────────┬──────────────┤
│          │                                               │              │
│  订单簿   │              K 线 图                          │   下单面板   │
│          │                                               │              │
│  买盘     ├───────────────────────────────────────────────┤   杠杆选择   │
│  卖盘     │                                               │   开多/开空  │
│          │     底部标签页                                  │   价格输入   │
│  最新成交 │  持仓 | 挂单 | 历史 | 猎杀场 | 风控            │   数量输入   │
│          │                                               │   确认按钮   │
└──────────┴───────────────────────────────────────────────┴──────────────┘
```

---

## 一、顶部信息栏

### 1.1 代币名称和状态

| 显示位置 | 显示内容 | 例子 | 数据来源 | 后端接口 |
|---------|---------|------|---------|---------|
| 最左边 | 代币名称-PERP | "DOGE-PERP" | 从网址参数获取代币地址，然后从区块链读取代币名称 | 区块链直接读取 |
| 名称右边 | 状态标签 | 绿色"Perpetual"或黄色"未开启" | 从区块链读取这个代币是否开启了合约交易 | 区块链直接读取 |

### 1.2 当前价格和涨跌

| 显示位置 | 显示内容 | 例子 | 数据来源 | 后端接口 |
|---------|---------|------|---------|---------|
| 名称后面 | 当前价格（大字） | "$0.00001234" | 从区块链的代币池子读取现货价格，乘以以太坊价格换算成美元 | 区块链直接读取 |
| 价格后面 | 涨跌幅 | "+5.23%" | 从后端服务器获取24小时价格变化 | `/api/stats/代币地址` |

### 1.3 市场数据

| 显示位置 | 显示内容 | 例子 | 数据来源 | 后端接口 |
|---------|---------|------|---------|---------|
| 信息栏中部 | 市值 | "$1.5M" | 从区块链的代币池子读取，乘以以太坊价格换算 | 区块链直接读取 |
| 信息栏中部 | 资金费率 | "0.01%" | 后端服务器 | `/api/funding/代币地址` |
| 信息栏中部 | 下次结算倒计时 | "23:45:12" | 后端返回下次结算时间，前端自己倒计时 | `/api/funding/代币地址` |
| 信息栏中部 | 持仓量 | "$50K" | 后端服务器 | `/api/stats/代币地址` |
| 信息栏中部 | 24小时成交量 | "$120K" | 后端服务器 | `/api/stats/代币地址` |
| 信息栏中部 | 24小时最高价 | "$0.00001500" | 后端服务器 | `/api/stats/代币地址` |
| 信息栏中部 | 24小时最低价 | "$0.00001100" | 后端服务器 | `/api/stats/代币地址` |
| 信息栏中部 | 24小时成交笔数 | "156" | 后端服务器 | `/api/stats/代币地址` |

### 1.4 风险警告区域（右上角）

| 显示位置 | 显示内容 | 例子 | 数据来源 | 后端接口 |
|---------|---------|------|---------|---------|
| 右上角 | 风险警报铃铛（红色数字） | "3" | 后端通过实时连接推送 | WebSocket 推送 |
| 右上角 | 风险等级标签 | "Risk: HIGH" | 后端计算后推送，根据仓位距离爆仓远近 | WebSocket 推送 |
| 右上角 | 保险基金余额 | "$1,234" | 后端服务器 | `/api/risk/market/代币地址` |

### 1.5 账户余额按钮

| 显示位置 | 显示内容 | 例子 | 数据来源 | 后端接口 |
|---------|---------|------|---------|---------|
| 最右边 | 可用余额 | "$500.00" | 从后端获取交易钱包余额 | `/api/user/钱包地址/balance` |

---

## 二、左侧订单簿

### 2.1 卖盘（上半部分，红色背景）

| 显示内容 | 例子 | 数据来源 | 后端接口 |
|---------|------|---------|---------|
| 价格 | "$0.00001250" | 后端实时连接推送 | WebSocket 推送 |
| 数量 | "50K" | 后端实时连接推送 | WebSocket 推送 |
| 累计数量 | "150K" | 前端根据数量自己累加 | - |
| 深度条（红色长度） | | 前端根据累计数量计算宽度 | - |

### 2.2 买盘（下半部分，绿色背景）

| 显示内容 | 例子 | 数据来源 | 后端接口 |
|---------|------|---------|---------|
| 价格 | "$0.00001230" | 后端实时连接推送 | WebSocket 推送 |
| 数量 | "80K" | 后端实时连接推送 | WebSocket 推送 |
| 累计数量 | "200K" | 前端根据数量自己累加 | - |
| 深度条（绿色长度） | | 前端根据累计数量计算宽度 | - |

### 2.3 最新成交（订单簿下方）

| 显示内容 | 例子 | 数据来源 | 后端接口 |
|---------|------|---------|---------|
| 成交价格 | "$0.00001240" | 后端实时连接推送 | WebSocket 推送 |
| 成交数量 | "10K" | 后端实时连接推送 | WebSocket 推送 |
| 成交时间 | "14:32:15" | 后端实时连接推送 | WebSocket 推送 |
| 颜色（红/绿） | | 根据价格比上一笔涨还是跌决定 | - |

### 2.4 点击价格的功能

**操作**: 点击订单簿中的任意价格

**效果**: 该价格会自动填入右侧下单面板的价格输入框

---

## 三、中间K线图

### 3.1 K线图数据

| 显示内容 | 数据来源 | 后端接口 |
|---------|---------|---------|
| 蜡烛图（开盘价、最高价、最低价、收盘价） | 后端服务器 | `/api/kline/代币地址?interval=1m` |
| 成交量柱状图 | 后端服务器 | 同上 |
| 当前价格横线 | 实时连接推送的最新价格 | WebSocket 推送 |

### 3.2 时间周期切换

| 可选周期 | 点击后的操作 |
|---------|------------|
| 1分钟 | 重新从后端获取1分钟K线数据 |
| 5分钟 | 重新从后端获取5分钟K线数据 |
| 15分钟 | 重新从后端获取15分钟K线数据 |
| 1小时 | 重新从后端获取1小时K线数据 |
| 4小时 | 重新从后端获取4小时K线数据 |
| 1天 | 重新从后端获取日K线数据 |

---

## 四、底部标签页

### 4.1 标签页切换

| 标签名 | 功能说明 |
|-------|---------|
| 持仓 | 显示我当前持有的仓位 |
| 当前挂单 | 显示我还没成交的订单 |
| 历史订单 | 显示已完成或已取消的订单 |
| 成交历史 | 显示所有成交记录 |
| 猎杀场 | 显示所有人的仓位和清算信息 |
| 风险控制 | 显示风险警报和保险基金 |

---

### 4.2 持仓标签页（我的仓位）

#### 表格每一列的说明

| 列名 | 显示内容例子 | 数据来源 | 后端接口 |
|-----|-------------|---------|---------|
| 交易对 | "DOGE-PERP" | 固定显示当前代币 | - |
| 仓位编号 | "#abc12345" | 后端返回的仓位唯一标识 | WebSocket 推送 |
| 方向 | "多" 或 "空" | 后端返回，开仓时选择的 | WebSocket 推送 |
| 杠杆 | "10x" | 后端返回，开仓时选择的 | WebSocket 推送 |
| 仓位大小 | "100K" | 后端返回的代币数量 | WebSocket 推送 |
| 仓位价值 | "$1,234" | 前端用数量乘以标记价格算出来 | - |
| 开仓均价 | "$0.00001200" | 后端返回，开仓时的成交价格 | WebSocket 推送 |
| 标记价格 | "$0.00001300" | **后端实时推送**，当前市场价格 | WebSocket 推送 |
| 强平价格 | "$0.00001050" | **后端实时推送**，到这个价会被强制平仓 | WebSocket 推送 |
| 保证金 | "$100" | 后端返回，开仓时投入的本金 | WebSocket 推送 |
| 维持保证金率 | "2%" | 后端返回 | WebSocket 推送 |
| 保证金率 | "45%" | **后端实时推送**，越接近100%越危险 | WebSocket 推送 |
| 未实现盈亏 | "+$50" 或 "-$30" | **后端实时推送**，当前赚了还是亏了 | WebSocket 推送 |
| 收益率 | "+50%" 或 "-30%" | **后端实时推送**，盈亏除以保证金的百分比 | WebSocket 推送 |
| 止盈止损 | "设置"按钮 | 点击可以设置（功能待实现） | - |
| 操作 | "平仓"、"调整"按钮 | 点击执行对应操作 | - |

#### "平仓"按钮功能

**点击后执行的步骤**:

1. 页面显示提示"正在平仓..."
2. 向后端发送平仓请求，带上仓位编号
3. 后端接口: `POST /api/position/仓位编号/close`
4. 等待后端返回结果
5. 成功: 显示"平仓成功"
6. 失败: 显示错误原因
7. 刷新仓位列表

#### 保证金率颜色说明

| 保证金率范围 | 颜色 | 含义 |
|------------|------|------|
| 0% - 60% | 绿色 | 安全 |
| 60% - 80% | 黄色 | 警告 |
| 80% - 100% | 红色闪烁 | 危险，即将爆仓 |

---

### 4.3 当前挂单标签页

#### 表格每一列的说明

| 列名 | 显示内容例子 | 数据来源 | 后端接口 |
|-----|-------------|---------|---------|
| 时间 | "14:32:15" | 后端返回的订单创建时间 | `/api/user/钱包地址/orders` |
| 交易对 | "DOGE-PERP" | 固定当前代币 | - |
| 类型 | "市价" 或 "限价" | 后端返回，下单时选择的 | 同上 |
| 方向 | "多" 或 "空" | 后端返回，下单时选择的 | 同上 |
| 杠杆 | "10x" | 后端返回 | 同上 |
| 委托价 | "$0.00001200" | 后端返回，下单时设置的价格 | 同上 |
| 委托量 | "100K" | 后端返回，下单时设置的数量 | 同上 |
| 成交均价 | "$0.00001205" | 后端返回，实际成交的价格 | 同上 |
| 已成交/总量 | "50K/100K" | 后端返回 | 同上 |
| 成交百分比 | "50%" | 前端计算: 已成交 ÷ 总量 × 100 | - |
| 保证金 | "$100" | 后端返回 | 同上 |
| 手续费 | "$0.05" | 后端返回 | 同上 |
| 状态 | "等待中" 或 "部分成交" | 后端返回 | 同上 |
| 操作 | "撤单"按钮 | 点击可以取消订单 | - |

#### "撤单"按钮功能

**点击后执行的步骤**:

1. 按钮文字变成"撤销中..."
2. 用交易钱包的私钥签名撤单请求
3. 向后端发送撤单请求
4. 后端接口: `POST /api/order/订单编号/cancel`
5. 等待后端返回结果
6. 成功: 显示"撤单成功"
7. 失败: 显示错误原因
8. 刷新订单列表

---

### 4.4 历史订单标签页

显示所有已完成或已取消的订单

| 列名 | 数据来源 |
|-----|---------|
| 交易对 | 本地存储 |
| 类型 | 本地存储 |
| 方向 | 本地存储 |
| 价格 | 本地存储 |
| 成交量 | 本地存储 |
| 状态 | 本地存储 |
| 时间 | 本地存储 |

---

### 4.5 成交历史标签页

显示所有成交记录

| 列名 | 数据来源 |
|-----|---------|
| 交易对 | 本地存储 |
| 方向 | 本地存储 |
| 价格 | 本地存储 |
| 数量 | 本地存储 |
| 手续费 | 本地存储 |
| 实现盈亏 | 本地存储 |
| 时间 | 本地存储 |

---

### 4.6 猎杀场标签页

#### 左上：清算热力图

| 显示内容 | 数据来源 | 后端接口 |
|---------|---------|---------|
| 2D热力图 | 后端服务器 | `/api/liquidation-heatmap/代币地址?timeRange=1d` |
| X轴（时间） | 后端返回 | 同上 |
| Y轴（价格） | 后端返回 | 同上 |
| 颜色深浅 | 后端返回的强度值 | 同上 |
| 当前价格线（黄色虚线） | 后端返回 | 同上 |
| 多头总清算量 | 后端返回 | 同上 |
| 空头总清算量 | 后端返回 | 同上 |
| 多头账户数 | 后端返回 | 同上 |
| 空头账户数 | 后端返回 | 同上 |

**时间范围选择器**:

| 选项 | 点击后的操作 |
|-----|------------|
| 12h | 重新获取12小时内的热力图数据 |
| 1d | 重新获取1天内的热力图数据 |
| 3d | 重新获取3天内的热力图数据 |
| 7d | 重新获取7天内的热力图数据 |
| 1m | 重新获取1个月内的热力图数据 |

**刷新按钮**: 点击立即重新获取最新数据

**鼠标悬停提示**: 显示该位置的价格、时间、多头清算量、空头清算量、账户数

#### 左下：猎手排行榜

| 显示内容 | 数据来源 | 后端接口 |
|---------|---------|---------|
| 总清算次数 | 后端服务器 | `/api/hunters?period=all` |
| 排名 | 后端返回 | 同上 |
| 钱包地址 | 后端返回 | 同上 |
| 清算次数 | 后端返回 | 同上 |
| 利润 | 后端返回 | 同上 |
| 最后清算时间 | 后端返回 | 同上 |

**时间段选择器**:

| 选项 | 点击后的操作 |
|-----|------------|
| 24H | 获取24小时内的排行榜 |
| 7D | 获取7天内的排行榜 |
| ALL | 获取全部时间的排行榜 |

**实时清算通知**: 后端通过 WebSocket 实时推送，有人被清算时显示

#### 右侧：全部持仓

| 显示内容 | 数据来源 | 后端接口 |
|---------|---------|---------|
| 总持仓数 | 后端服务器 | `/api/hunting/positions/代币地址` |
| 危险仓位数（红色） | 后端返回 | 同上 |
| 警告仓位数（黄色） | 后端返回 | 同上 |
| 当前价格 | 后端返回 | 同上 |

**过滤器按钮**:

| 选项 | 功能 |
|-----|------|
| 全部 | 显示所有仓位 |
| 🔴 | 只显示危险仓位 |
| 🟡 | 只显示警告仓位 |
| 多 | 只显示多头仓位 |
| 空 | 只显示空头仓位 |

**每行仓位显示的内容**:

| 列名 | 显示内容例子 | 数据来源 |
|-----|-------------|---------|
| 持仓人地址 | "0x1234...5678" | 后端返回 |
| 方向和杠杆 | "L10x" 或 "S50x" | 后端返回 |
| 仓位大小 | "100K" | 后端返回 |
| 保证金 | "$100" | 后端返回 |
| 开仓价 | "$0.00001200" | 后端返回 |
| 清算价 | "$0.00001050" | 后端返回 |
| 盈亏 | "+$50" | 后端返回 |
| 盈亏百分比 | "+50%" | 后端返回 |
| 风险进度条 | 绿色/黄色/红色 | 前端根据价格计算 |

**风险进度条颜色说明**:

| 进度百分比 | 颜色 | 含义 |
|-----------|------|------|
| 75% - 100% | 绿色 | 安全，离清算价很远 |
| 50% - 75% | 黄色 | 警告，需要注意 |
| 0% - 50% | 红色 | 危险，接近清算价 |

---

### 4.7 风险控制标签页

| 显示内容 | 数据来源 | 后端接口 |
|---------|---------|---------|
| 风险警报列表 | 后端 WebSocket 推送 | WebSocket |
| 保险基金余额 | 后端服务器 | `/api/risk/market/代币地址` |
| 保险基金利用率 | 后端服务器 | 同上 |
| 各仓位风险等级 | 后端 WebSocket 推送 | WebSocket |

---

## 五、右侧下单面板

### 5.1 杠杆选择

| 显示内容 | 功能说明 |
|---------|---------|
| 滑块（1-100） | 拖动选择杠杆倍数 |
| 当前杠杆显示 | 例如 "10x" |
| 快捷按钮 | 5x、10x、20x、50x、100x |

### 5.2 开多/开空选择

| 按钮 | 功能说明 |
|-----|---------|
| 开多（绿色） | 选择做多，预期价格上涨赚钱 |
| 开空（红色） | 选择做空，预期价格下跌赚钱 |

### 5.3 订单类型选择

| 选项 | 功能说明 |
|-----|---------|
| 限价 | 需要输入价格，到达该价格才成交 |
| 市价 | 立即按当前市场价格成交 |

### 5.4 输入框

| 输入框 | 功能说明 | 备注 |
|-------|---------|------|
| 价格 | 输入希望成交的价格 | 只有限价单需要填 |
| 数量 | 输入要买入的代币数量 | 必填 |

### 5.5 自动计算显示

| 显示内容 | 计算方式 |
|---------|---------|
| 所需保证金 | 数量 × 价格 ÷ 杠杆 |
| 预估强平价 | 根据杠杆和方向计算 |
| 手续费预估 | 数量 × 价格 × 手续费率 |

### 5.6 确认下单按钮

**点击后执行的步骤**:

1. 检查是否已连接钱包
   - 未连接: 提示"请先连接钱包"
2. 检查是否已创建交易钱包
   - 未创建: 提示"请先创建交易钱包"
3. 检查余额是否足够
   - 不足: 提示"余额不足"
4. 用交易钱包的私钥签名订单数据
5. 把签名后的订单发送到后端
6. 后端接口: `POST /api/order/submit`
7. 等待后端返回结果
8. 成功: 显示"订单已提交"
9. 失败: 显示错误原因
10. 刷新订单列表和仓位列表

---

## 六、账户余额弹窗

点击右上角的余额按钮后弹出

### 6.1 显示的信息

| 显示内容 | 数据来源 | 后端接口 |
|---------|---------|---------|
| 主钱包余额 | 区块链直接读取 | 区块链 |
| 交易钱包地址 | 本地存储 | - |
| 交易钱包余额 | 后端服务器 | `/api/user/钱包地址/balance` |
| 可用余额 | 后端返回 | 同上 |
| 已用保证金 | 后端返回 | 同上 |
| 未实现盈亏 | 后端返回 | 同上 |

### 6.2 充值功能

**操作步骤**:

1. 输入充值金额
2. 点击"充值"按钮
3. 钱包弹出确认交易
4. 确认后调用区块链合约存钱
5. 等待交易确认
6. 刷新余额显示

### 6.3 提现功能

**操作步骤**:

1. 输入提现金额
2. 点击"提现"按钮
3. 钱包弹出确认交易
4. 确认后调用区块链合约取钱
5. 等待交易确认
6. 刷新余额显示

---

## 七、数据更新方式汇总

| 数据类型 | 更新方式 | 更新频率 | 后端接口 |
|---------|---------|---------|---------|
| 订单簿 | WebSocket 实时推送 | 实时 | WebSocket |
| 最新成交 | WebSocket 实时推送 | 实时 | WebSocket |
| 我的仓位 | WebSocket 推送 + 定时拉取 | 实时 + 每5秒 | WebSocket + HTTP |
| 仓位盈亏 | WebSocket 实时推送 | 实时（约100毫秒） | WebSocket |
| 我的订单 | 定时拉取 | 每5秒 | `/api/user/钱包地址/orders` |
| 当前价格 | 区块链读取 | 每次刷新页面 | 区块链 |
| 资金费率 | 定时拉取 | 每30秒 | `/api/funding/代币地址` |
| 24小时统计 | 定时拉取 | 每30秒 | `/api/stats/代币地址` |
| K线图 | 首次加载 + 实时更新 | 实时 | `/api/kline/代币地址` |
| 猎杀场-热力图 | 定时拉取 | 每5秒 | `/api/liquidation-heatmap/代币地址` |
| 猎杀场-全部持仓 | 定时拉取 | 每3秒 | `/api/hunting/positions/代币地址` |
| 猎杀场-排行榜 | 定时拉取 | 每10秒 | `/api/hunters` |
| 风险警报 | WebSocket 实时推送 | 实时 | WebSocket |

---

## 八、后端接口清单

### 8.1 行情数据接口

| 接口路径 | 方法 | 功能 | 返回数据 |
|---------|------|------|---------|
| `/api/stats/代币地址` | GET | 获取24小时统计 | 价格、涨跌、最高、最低、成交量 |
| `/api/funding/代币地址` | GET | 获取资金费率 | 当前费率、下次结算时间 |
| `/api/kline/代币地址` | GET | 获取K线数据 | K线数组 |
| `/api/orderbook/代币地址` | GET | 获取订单簿快照 | 买卖盘数据 |
| `/api/trades/代币地址` | GET | 获取最新成交 | 成交记录数组 |

### 8.2 用户数据接口

| 接口路径 | 方法 | 功能 | 返回数据 |
|---------|------|------|---------|
| `/api/user/钱包地址/balance` | GET | 获取账户余额 | 总余额、可用、已用、盈亏 |
| `/api/user/钱包地址/positions` | GET | 获取我的仓位 | 仓位数组 |
| `/api/user/钱包地址/orders` | GET | 获取我的订单 | 订单数组 |
| `/api/user/钱包地址/nonce` | GET | 获取下单序号 | 序号值 |

### 8.3 交易接口

| 接口路径 | 方法 | 功能 | 需要的参数 |
|---------|------|------|----------|
| `/api/order/submit` | POST | 提交订单 | 签名后的订单数据 |
| `/api/order/订单编号/cancel` | POST | 撤销订单 | 订单编号、签名 |
| `/api/position/仓位编号/close` | POST | 平仓 | 仓位编号 |

### 8.4 猎杀场接口

| 接口路径 | 方法 | 功能 | 返回数据 |
|---------|------|------|---------|
| `/api/liquidation-heatmap/代币地址` | GET | 获取清算热力图 | 热力图矩阵数据 |
| `/api/hunting/positions/代币地址` | GET | 获取全部持仓 | 所有人的仓位数组 |
| `/api/hunters` | GET | 获取猎手排行榜 | 排行榜数据 |

### 8.5 风控接口

| 接口路径 | 方法 | 功能 | 返回数据 |
|---------|------|------|---------|
| `/api/risk/user/钱包地址` | GET | 获取用户风险 | 风险等级、警报 |
| `/api/risk/market/代币地址` | GET | 获取市场风险 | 保险基金、整体风险 |

### 8.6 WebSocket 连接

| 连接地址 | 功能 | 推送的数据 |
|---------|------|----------|
| `ws://后端地址` | 实时数据推送 | 订单簿、成交、仓位盈亏、风险警报 |

---

## 九、常见问题

### 问题1：为什么数据显示为空？

可能的原因：
1. 后端服务器没有启动
2. 网络连接有问题
3. 代币地址格式不正确（大小写问题）
4. 确实没有数据（没有仓位、没有订单等）

### 问题2：为什么盈亏数字不变？

可能的原因：
1. WebSocket 连接断开了
2. 后端没有在实时计算
3. 价格没有变化

### 问题3：为什么下单失败？

可能的原因：
1. 没有连接钱包
2. 没有创建交易钱包
3. 余额不足
4. 签名失败
5. 后端服务器错误

---

*文档最后更新时间: 2026年1月31日*
