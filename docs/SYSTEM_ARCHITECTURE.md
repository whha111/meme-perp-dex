# 系统架构文档

> 完整的技术架构、通信规范、功能闭环

## 目录
1. [项目结构](#一项目结构)
2. [技术栈](#二技术栈)
3. [系统架构图](#三系统架构图)
4. [HTTP vs WebSocket 使用规范](#四http-vs-websocket-使用规范)
5. [功能闭环](#五功能闭环)
6. [数据流设计](#六数据流设计)
7. [模块边界](#七模块边界)

---

## 一、项目结构

```
meme-perp-dex/
│
├── frontend/                    # 前端 (React + TypeScript)
│   ├── public/
│   ├── src/
│   │   ├── api/                 # HTTP API 请求封装
│   │   ├── components/          # UI 组件
│   │   ├── hooks/               # 自定义 Hooks
│   │   ├── pages/               # 页面
│   │   ├── services/            # WebSocket 服务
│   │   ├── store/               # 状态管理 (Zustand)
│   │   ├── types/               # TypeScript 类型
│   │   ├── utils/               # 工具函数
│   │   └── App.tsx
│   ├── package.json
│   ├── tsconfig.json
│   └── vite.config.ts
│
├── backend/                     # 后端 (Go + Gin)
│   ├── cmd/
│   │   ├── api/                 # API 服务入口
│   │   ├── keeper/              # Keeper 服务入口
│   │   └── indexer/             # 链上数据索引服务
│   ├── internal/
│   │   ├── api/                 # HTTP API 处理器
│   │   ├── ws/                  # WebSocket 处理器
│   │   ├── service/             # 业务逻辑层
│   │   ├── repository/          # 数据访问层
│   │   ├── model/               # 数据模型
│   │   ├── middleware/          # 中间件
│   │   └── pkg/                 # 公共包
│   ├── configs/                 # 配置文件
│   ├── migrations/              # 数据库迁移
│   ├── go.mod
│   └── go.sum
│
├── contracts/                   # 智能合约 (Solidity + Foundry)
│   ├── src/
│   │   ├── core/                # 核心合约
│   │   ├── tokens/              # 代币合约
│   │   ├── periphery/           # 外围合约
│   │   └── interfaces/          # 接口定义
│   ├── test/                    # 测试
│   ├── script/                  # 部署脚本
│   ├── foundry.toml
│   └── remappings.txt
│
├── docs/                        # 文档
│   ├── PRD.md
│   ├── API_SPECIFICATION.md
│   ├── DEVELOPMENT_STANDARDS.md
│   └── SYSTEM_ARCHITECTURE.md
│
├── docker-compose.yml           # Docker 编排
├── Makefile                     # 构建脚本
└── README.md
```

---

## 二、技术栈

### 2.1 前端

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | UI 框架 |
| TypeScript | 5.x | 类型安全 |
| Vite | 5.x | 构建工具 |
| Zustand | 4.x | 状态管理 |
| TanStack Query | 5.x | 数据请求/缓存 |
| Tailwind CSS | 3.x | 样式 |
| Lightweight Charts | 4.x | K线图表 |
| Wagmi + Viem | 2.x | Web3 连接 |
| Axios | 1.x | HTTP 请求 |

### 2.2 后端

| 技术 | 版本 | 用途 |
|------|------|------|
| Go | 1.22+ | 开发语言 |
| Gin | 1.9+ | Web 框架 |
| GORM | 2.x | ORM |
| gorilla/websocket | 1.5+ | WebSocket |
| Redis | 7.x | 缓存/订阅 |
| PostgreSQL | 16.x | 主数据库 |
| TimescaleDB | - | 时序数据 (K线) |
| go-ethereum | 1.13+ | 链上交互 |

### 2.3 智能合约

| 技术 | 版本 | 用途 |
|------|------|------|
| Solidity | 0.8.20+ | 合约语言 |
| Foundry | - | 开发框架 |
| OpenZeppelin | 5.x | 安全库 |

### 2.4 基础设施

| 技术 | 用途 |
|------|------|
| Docker | 容器化 |
| Nginx | 反向代理/负载均衡 |
| Prometheus + Grafana | 监控 |
| ELK Stack | 日志 |

---

## 三、系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                  用户层                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         React Frontend                               │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐ │   │
│  │  │  Pages   │  │  Store   │  │   API    │  │    WebSocket Client  │ │   │
│  │  │ (Trading │  │ (Zustand)│  │ (Axios)  │  │    (实时数据订阅)     │ │   │
│  │  │  Order   │  │          │  │          │  │                      │ │   │
│  │  │ Position)│  │          │  │          │  │                      │ │   │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └──────────┬───────────┘ │   │
│  └───────┼─────────────┼─────────────┼───────────────────┼─────────────┘   │
└──────────┼─────────────┼─────────────┼───────────────────┼─────────────────┘
           │             │             │                   │
           │   状态更新   │    HTTP     │      WebSocket    │
           ▼             ▼             ▼                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 网关层                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                            Nginx                                     │   │
│  │              (SSL终止 / 负载均衡 / 路由 / 限流)                        │   │
│  └──────────────────────────┬──────────────────────────────────────────┘   │
└─────────────────────────────┼──────────────────────────────────────────────┘
                              │
           ┌──────────────────┼──────────────────┐
           │                  │                  │
           ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                服务层 (Go)                                   │
│                                                                             │
│  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────────┐   │
│  │   API Server      │  │   WebSocket Hub   │  │    Keeper Service     │   │
│  │   (HTTP REST)     │  │   (实时推送)       │  │    (链上执行)          │   │
│  │                   │  │                   │  │                       │   │
│  │ • 账户查询        │  │ • Ticker 推送     │  │ • 清算执行            │   │
│  │ • 下单/撤单       │  │ • K线推送         │  │ • 订单执行            │   │
│  │ • 历史查询        │  │ • 深度推送        │  │ • 资金费结算          │   │
│  │ • 设置操作        │  │ • 成交推送        │  │ • 止盈止损触发        │   │
│  │                   │  │ • 持仓/订单推送   │  │                       │   │
│  └─────────┬─────────┘  └─────────┬─────────┘  └───────────┬───────────┘   │
│            │                      │                        │               │
│  ┌─────────┴──────────────────────┴────────────────────────┴───────────┐   │
│  │                         Service Layer (业务逻辑)                     │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │ Trading  │  │ Account  │  │  Market  │  │  Price   │            │   │
│  │  │ Service  │  │ Service  │  │ Service  │  │ Service  │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │
           ┌───────────────────────┼───────────────────────┐
           │                       │                       │
           ▼                       ▼                       ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────┐
│    PostgreSQL       │  │       Redis         │  │    Blockchain (BSC)     │
│    + TimescaleDB    │  │                     │  │                         │
│                     │  │ • 实时价格缓存      │  │  ┌───────────────────┐  │
│ • 用户数据          │  │ • 订单簿缓存        │  │  │  Smart Contracts  │  │
│ • 订单数据          │  │ • 会话管理          │  │  │                   │  │
│ • 持仓数据          │  │ • 消息订阅/发布     │  │  │ • PositionManager │  │
│ • K线数据           │  │ • 限流计数          │  │  │ • Vault           │  │
│ • 账单流水          │  │                     │  │  │ • AMM             │  │
│                     │  │                     │  │  │ • LiquidityPool   │  │
└─────────────────────┘  └─────────────────────┘  │  └───────────────────┘  │
                                                  └─────────────────────────┘
```

---

## 四、HTTP vs WebSocket 使用规范

### 4.1 使用原则

| 通信方式 | 适用场景 | 特点 |
|----------|----------|------|
| **HTTP** | 一次性操作、历史数据查询、状态变更 | 请求-响应模式，有明确结果 |
| **WebSocket** | 实时数据、状态变化推送 | 服务端主动推送，低延迟 |

### 4.2 HTTP 请求场景 (必须用 HTTP)

#### 账户操作
| 功能 | 端点 | 说明 |
|------|------|------|
| 获取账户余额 | `GET /account/balance` | 查询当前余额快照 |
| 获取持仓列表 | `GET /account/positions` | 查询所有持仓 |
| 设置杠杆 | `POST /account/set-leverage` | 修改杠杆设置 |
| 调整保证金 | `POST /account/margin-balance` | 增减保证金 |
| 获取账单流水 | `GET /account/bills` | 查询历史账单 |

#### 交易操作
| 功能 | 端点 | 说明 |
|------|------|------|
| **下单** | `POST /trade/order` | 提交新订单 |
| **撤单** | `POST /trade/cancel-order` | 撤销订单 |
| **修改订单** | `POST /trade/amend-order` | 修改价格/数量 |
| **平仓** | `POST /trade/close-position` | 市价平仓 |
| 设置止盈止损 | `POST /trade/order-algo` | 设置条件单 |
| 查询订单详情 | `GET /trade/order` | 查询单个订单 |
| 查询未完成订单 | `GET /trade/orders-pending` | 查询活跃订单 |
| 查询历史订单 | `GET /trade/orders-history` | 查询已完成订单 |

#### 市场数据 (初始加载)
| 功能 | 端点 | 说明 |
|------|------|------|
| 获取合约信息 | `GET /public/instruments` | 合约配置 |
| 获取历史K线 | `GET /market/candles` | 历史K线数据 |
| 获取资金费率历史 | `GET /market/funding-rate-history` | 历史费率 |

### 4.3 WebSocket 推送场景 (必须用 WebSocket)

#### 公共频道 (无需登录)

| 频道 | 推送频率 | 数据内容 |
|------|----------|----------|
| `tickers` | 100ms | 最新价、买一卖一、24h统计 |
| `candle{period}` | K线更新时 | 实时K线数据 |
| `trades` | 成交时 | 最新成交记录 |
| `books` | 100ms | 订单簿深度变化 |
| `books5` | 100ms | 5档深度快照 |
| `mark-price` | 1s | 标记价格 |
| `funding-rate` | 1min | 当前/预测资金费率 |

#### 私有频道 (需登录)

| 频道 | 推送时机 | 数据内容 |
|------|----------|----------|
| `account` | 余额变化时 | 账户余额更新 |
| `positions` | 持仓变化时 | 持仓信息更新 |
| `orders` | 订单状态变化时 | 订单状态更新 |
| `orders-algo` | 条件单触发时 | 条件单状态 |
| `liquidation-warning` | 接近清算时 | 清算预警 |

### 4.4 前端数据流设计

```
┌────────────────────────────────────────────────────────────────────────┐
│                           前端数据管理                                  │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    初始化流程 (HTTP)                             │  │
│  │                                                                  │  │
│  │  1. 获取合约信息    GET /public/instruments                      │  │
│  │  2. 连接钱包后:                                                  │  │
│  │     - 获取账户余额  GET /account/balance                         │  │
│  │     - 获取持仓列表  GET /account/positions                       │  │
│  │     - 获取未完成订单 GET /trade/orders-pending                   │  │
│  │  3. 进入交易页:                                                  │  │
│  │     - 获取历史K线   GET /market/candles?limit=500                │  │
│  │                                                                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                              │                                         │
│                              ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    实时更新 (WebSocket)                          │  │
│  │                                                                  │  │
│  │  公共频道订阅:                                                    │  │
│  │  ┌─────────────┬─────────────────────────────────────────────┐  │  │
│  │  │ tickers     │ -> 更新 priceStore (最新价、涨跌幅)          │  │  │
│  │  │ candle1m    │ -> 更新 candleStore (K线图实时更新)          │  │  │
│  │  │ books5      │ -> 更新 orderbookStore (买卖盘)              │  │  │
│  │  │ trades      │ -> 更新 tradesStore (最新成交)               │  │  │
│  │  │ mark-price  │ -> 更新 priceStore (标记价格)                │  │  │
│  │  │ funding-rate│ -> 更新 fundingStore (资金费率)              │  │  │
│  │  └─────────────┴─────────────────────────────────────────────┘  │  │
│  │                                                                  │  │
│  │  私有频道订阅 (登录后):                                          │  │
│  │  ┌─────────────┬─────────────────────────────────────────────┐  │  │
│  │  │ account     │ -> 更新 accountStore (余额变化)              │  │  │
│  │  │ positions   │ -> 更新 positionStore (持仓变化)             │  │  │
│  │  │ orders      │ -> 更新 orderStore (订单状态变化)            │  │  │
│  │  │ liquidation │ -> 触发 UI 警告 (清算预警)                   │  │  │
│  │  └─────────────┴─────────────────────────────────────────────┘  │  │
│  │                                                                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                              │                                         │
│                              ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    用户操作 (HTTP)                               │  │
│  │                                                                  │  │
│  │  用户点击下单:                                                   │  │
│  │  1. POST /trade/order           -> 返回 ordId                   │  │
│  │  2. WebSocket 推送订单状态变化   -> 更新 orderStore              │  │
│  │  3. WebSocket 推送持仓变化       -> 更新 positionStore           │  │
│  │  4. WebSocket 推送余额变化       -> 更新 accountStore            │  │
│  │                                                                  │  │
│  │  用户点击撤单:                                                   │  │
│  │  1. POST /trade/cancel-order    -> 返回成功                     │  │
│  │  2. WebSocket 推送订单状态=canceled -> 更新 orderStore          │  │
│  │                                                                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

### 4.5 关键规则

```
┌────────────────────────────────────────────────────────────────────────┐
│                           使用规则总结                                  │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ✅ 必须用 HTTP:                                                       │
│     • 所有写操作 (下单、撤单、设置)                                     │
│     • 历史数据查询 (历史K线、历史订单、账单)                            │
│     • 初始化数据加载                                                   │
│     • 需要明确成功/失败响应的操作                                       │
│                                                                        │
│  ✅ 必须用 WebSocket:                                                  │
│     • 实时行情 (价格、K线、深度、成交)                                  │
│     • 状态变化通知 (订单、持仓、余额)                                   │
│     • 清算预警                                                         │
│     • 资金费率更新                                                     │
│                                                                        │
│  ❌ 禁止:                                                              │
│     • 用轮询代替 WebSocket 获取实时数据                                 │
│     • 用 WebSocket 发送交易指令                                        │
│     • 依赖 HTTP 获取实时价格                                            │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 五、功能闭环

### 5.1 内盘认购闭环

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          内盘认购功能闭环                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  用户操作              前端                后端                 合约     │
│  ────────              ────                ────                 ────     │
│                                                                         │
│  1. 查看认购信息                                                        │
│     ────────────────>  GET /presale/info                                │
│                        <──────────────────  返回: 进度/剩余/价格         │
│                                                                         │
│  2. 认购 MEME                                                           │
│     ────────────────>  调用合约 subscribe(amount)                       │
│                                             ──────────────────>  锁定BNB │
│                        <──────────────────────────────────────  tx hash │
│                                                                         │
│  3. 查看认购记录                                                        │
│     ────────────────>  GET /presale/my-subscriptions                    │
│                        <──────────────────  返回: 认购列表               │
│                                                                         │
│  4. 申请退款 (未满额时)                                                  │
│     ────────────────>  调用合约 refund()                                │
│                                             ──────────────────>  退还BNB │
│                        <──────────────────────────────────────  tx hash │
│                                                                         │
│  5. 认购满额触发                                                        │
│                                             合约自动:                   │
│                                             • 创建 AMM 流动性池         │
│                                             • 开启现货交易              │
│                                             • 开启合约交易              │
│                        <──────────────────  WS推送: 状态变更             │
│                                                                         │
│  6. 领取 MEME                                                           │
│     ────────────────>  调用合约 claim()                                 │
│                                             ──────────────────>  发送MEME│
│                        <──────────────────────────────────────  tx hash │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 现货交易闭环

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          现货交易功能闭环                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  用户操作              前端                后端/合约            状态更新  │
│  ────────              ────                ─────────            ────────  │
│                                                                         │
│  1. 查看行情                                                            │
│     ────────────────>  订阅 WS: tickers, books5, trades                 │
│                        <──────────────────  实时推送行情数据             │
│                                                                         │
│  2. 买入 MEME (BNB -> MEME)                                             │
│     ────────────────>  调用合约 swapExactBNBForMeme(minOut)             │
│                                             ──────────────────>  执行swap │
│                        <──────────────────────────────────────  tx hash │
│                        <──────────────────  WS: 余额变化                │
│                                                                         │
│  3. 卖出 MEME (MEME -> BNB)                                             │
│     ────────────────>  调用合约 swapExactMemeForBNB(amountIn, minOut)   │
│                                             ──────────────────>  执行swap │
│                        <──────────────────────────────────────  tx hash │
│                        <──────────────────  WS: 余额变化                │
│                                                                         │
│  4. 查看交易记录                                                        │
│     ────────────────>  GET /spot/my-trades                              │
│                        <──────────────────  返回: 交易历史               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 合约交易闭环

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          合约交易功能闭环                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【开仓流程】                                                           │
│                                                                         │
│  1. 设置杠杆                                                            │
│     ────────────────>  POST /account/set-leverage                       │
│                        <──────────────────  返回: 成功                   │
│                                                                         │
│  2. 市价开多                                                            │
│     ────────────────>  POST /trade/order                                │
│                        {instId, side:buy, posSide:long, ordType:market} │
│                        <──────────────────  返回: ordId                 │
│                        <──────────────────  WS: 订单状态 -> filled      │
│                        <──────────────────  WS: 持仓更新                │
│                        <──────────────────  WS: 余额更新                │
│                                                                         │
│  3. 限价开空                                                            │
│     ────────────────>  POST /trade/order                                │
│                        {instId, side:sell, posSide:short, ordType:limit}│
│                        <──────────────────  返回: ordId                 │
│                        <──────────────────  WS: 订单状态 -> live        │
│                        ... 等待成交 ...                                  │
│                        <──────────────────  WS: 订单状态 -> filled      │
│                        <──────────────────  WS: 持仓更新                │
│                                                                         │
│  【持仓管理】                                                           │
│                                                                         │
│  4. 查看持仓 (实时)                                                     │
│     ────────────────>  订阅 WS: positions                               │
│                        <──────────────────  实时推送: 持仓/盈亏/强平价   │
│                                                                         │
│  5. 设置止盈止损                                                        │
│     ────────────────>  POST /trade/order-algo                           │
│                        <──────────────────  返回: algoId                │
│                        ... 价格触发 ...                                  │
│                        <──────────────────  WS: 条件单触发              │
│                        <──────────────────  WS: 持仓关闭                │
│                                                                         │
│  【平仓流程】                                                           │
│                                                                         │
│  6. 市价平仓                                                            │
│     ────────────────>  POST /trade/close-position                       │
│                        <──────────────────  返回: 成功                   │
│                        <──────────────────  WS: 持仓 -> 0               │
│                        <──────────────────  WS: 余额更新 (含盈亏)        │
│                                                                         │
│  7. 限价平仓                                                            │
│     ────────────────>  POST /trade/order {reduceOnly: true}             │
│                        <──────────────────  返回: ordId                 │
│                        <──────────────────  WS: 订单状态更新             │
│                                                                         │
│  【清算流程】                                                           │
│                                                                         │
│  8. 清算预警                                                            │
│                        <──────────────────  WS: liquidation-warning     │
│                        前端显示预警UI                                    │
│                                                                         │
│  9. 被清算                                                              │
│                        <──────────────────  WS: 持仓 -> 0 (被清算)       │
│                        <──────────────────  WS: 余额更新                │
│                                                                         │
│  【资金费率】                                                           │
│                                                                         │
│  10. 每4小时结算                                                        │
│                        <──────────────────  WS: 余额更新 (资金费)        │
│     ────────────────>  GET /account/bills?type=4                        │
│                        <──────────────────  返回: 资金费账单             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.4 LP 流动性闭环

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          LP 流动性功能闭环                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 查看 LP 池信息                                                      │
│     ────────────────>  GET /lp/pool-info                                │
│                        <──────────────────  返回: TVL/APY/利用率         │
│                                                                         │
│  2. 存入 MEME 获取 LP Token                                             │
│     ────────────────>  调用合约 deposit(memeAmount)                     │
│                                             ──────────────────>  锁定MEME │
│                        <──────────────────────────────────────  tx hash │
│                        <──────────────────  WS: LP Token 余额更新       │
│                                                                         │
│  3. 查看收益                                                            │
│     ────────────────>  GET /lp/my-earnings                              │
│                        <──────────────────  返回: 累计收益/待领取        │
│                                                                         │
│  4. 提取收益                                                            │
│     ────────────────>  调用合约 claimRewards()                          │
│                                             ──────────────────>  发送收益 │
│                        <──────────────────────────────────────  tx hash │
│                                                                         │
│  5. 赎回 LP                                                             │
│     ────────────────>  调用合约 withdraw(lpAmount)                      │
│                                             ──────────────────>  返还MEME │
│                        <──────────────────────────────────────  tx hash │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 六、数据流设计

### 6.1 价格数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            价格数据流                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐                                                       │
│  │   AMM 合约   │  链上交易事件                                         │
│  │  (价格源)    │ ─────────────────┐                                    │
│  └──────────────┘                  │                                    │
│                                    ▼                                    │
│                          ┌──────────────────┐                           │
│                          │    Indexer       │                           │
│                          │  (链上数据索引)   │                           │
│                          └────────┬─────────┘                           │
│                                   │                                     │
│                                   ▼                                     │
│  ┌──────────────┐       ┌──────────────────┐       ┌──────────────┐    │
│  │   Redis      │<──────│   Price Service  │──────>│  PostgreSQL  │    │
│  │  (实时价格)   │       │   (价格计算)      │       │   (K线存储)  │    │
│  └──────┬───────┘       └──────────────────┘       └──────────────┘    │
│         │                                                               │
│         │  Pub/Sub                                                      │
│         ▼                                                               │
│  ┌──────────────────┐                                                   │
│  │  WebSocket Hub   │                                                   │
│  │  (消息分发)       │                                                   │
│  └────────┬─────────┘                                                   │
│           │                                                             │
│           ▼                                                             │
│  ┌──────────────────────────────────────────┐                          │
│  │              前端订阅者                   │                          │
│  │  • tickers -> 行情显示                   │                          │
│  │  • candles -> K线图表                    │                          │
│  │  • mark-price -> 盈亏计算                │                          │
│  └──────────────────────────────────────────┘                          │
│                                                                         │
│  更新频率:                                                              │
│  • 实时价格: 每笔交易更新                                               │
│  • Ticker 推送: 100ms 聚合                                              │
│  • K线推送: 实时 (未确认) + 周期结束 (确认)                              │
│  • 标记价格: 1s 更新                                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 订单数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            订单数据流                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐      POST /trade/order                               │
│  │    前端      │ ──────────────────────────────────────┐               │
│  └──────────────┘                                       │               │
│                                                         ▼               │
│                                               ┌──────────────────┐      │
│                                               │   API Server     │      │
│                                               │  (订单验证)       │      │
│                                               └────────┬─────────┘      │
│                                                        │                │
│         ┌──────────────────────────────────────────────┼────────┐       │
│         │                                              │        │       │
│         ▼                                              ▼        │       │
│  ┌──────────────┐                            ┌──────────────┐   │       │
│  │  PostgreSQL  │                            │    Redis     │   │       │
│  │ (订单存储)   │                            │  (订单簿)    │   │       │
│  └──────────────┘                            └──────┬───────┘   │       │
│                                                     │           │       │
│                                                     │ 撮合      │       │
│                                                     ▼           │       │
│                                            ┌──────────────────┐ │       │
│                                            │  Matching Engine │ │       │
│                                            │    (撮合引擎)     │ │       │
│                                            └────────┬─────────┘ │       │
│                                                     │           │       │
│         ┌───────────────────────────────────────────┤           │       │
│         │                     │                     │           │       │
│         ▼                     ▼                     ▼           │       │
│  ┌──────────────┐    ┌──────────────┐      ┌──────────────┐    │       │
│  │   更新订单   │    │   更新持仓   │      │ Keeper 执行  │    │       │
│  │    状态      │    │    数据      │      │  链上交易    │    │       │
│  └──────┬───────┘    └──────┬───────┘      └──────────────┘    │       │
│         │                   │                                   │       │
│         │  Redis Pub/Sub    │                                   │       │
│         ▼                   ▼                                   │       │
│  ┌──────────────────────────────────────────────────────────┐  │       │
│  │                    WebSocket Hub                          │  │       │
│  └──────────────────────────┬───────────────────────────────┘  │       │
│                             │                                   │       │
│                             ▼                                   │       │
│  ┌──────────────────────────────────────────────────────────┐  │       │
│  │                        前端                               │  │       │
│  │  • orders 频道 -> 订单状态更新                            │<─┘       │
│  │  • positions 频道 -> 持仓更新                             │          │
│  │  • account 频道 -> 余额更新                               │          │
│  └──────────────────────────────────────────────────────────┘          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 七、模块边界

### 7.1 前端模块边界

```
frontend/src/
│
├── api/                         # HTTP API 层
│   ├── client.ts               # Axios 实例配置
│   ├── market.ts               # 市场数据 API
│   ├── trade.ts                # 交易 API
│   ├── account.ts              # 账户 API
│   └── types.ts                # API 类型定义
│
├── services/                    # 服务层
│   ├── websocket/
│   │   ├── WebSocketManager.ts # WS 连接管理
│   │   ├── channels.ts         # 频道订阅逻辑
│   │   └── handlers.ts         # 消息处理器
│   └── contract/
│       ├── index.ts            # 合约交互入口
│       ├── presale.ts          # 内盘合约
│       ├── swap.ts             # 现货合约
│       └── position.ts         # 合约交易
│
├── store/                       # 状态管理
│   ├── useMarketStore.ts       # 行情数据
│   ├── useAccountStore.ts      # 账户数据
│   ├── usePositionStore.ts     # 持仓数据
│   ├── useOrderStore.ts        # 订单数据
│   └── useTradeStore.ts        # 交易相关
│
├── hooks/                       # 业务 Hooks
│   ├── useMarketData.ts        # 行情数据 Hook
│   ├── useTrade.ts             # 交易操作 Hook
│   ├── usePosition.ts          # 持仓管理 Hook
│   └── useWebSocket.ts         # WS 订阅 Hook
│
├── components/                  # UI 组件
│   ├── common/                 # 通用组件
│   ├── trading/                # 交易组件
│   │   ├── OrderForm.tsx       # 下单表单
│   │   ├── OrderBook.tsx       # 订单簿
│   │   ├── TradeHistory.tsx    # 成交记录
│   │   └── PositionList.tsx    # 持仓列表
│   ├── charts/                 # 图表组件
│   │   └── TradingChart.tsx    # K线图
│   └── layout/                 # 布局组件
│
└── pages/                       # 页面
    ├── Presale.tsx             # 内盘认购页
    ├── Trade.tsx               # 交易页
    ├── Pool.tsx                # LP 池页
    └── Portfolio.tsx           # 资产页
```

### 7.2 后端模块边界

```
backend/
│
├── cmd/                         # 入口
│   ├── api/
│   │   └── main.go             # API 服务入口
│   ├── keeper/
│   │   └── main.go             # Keeper 服务入口
│   └── indexer/
│       └── main.go             # 索引服务入口
│
├── internal/
│   ├── api/                    # HTTP 处理器
│   │   ├── handler/
│   │   │   ├── market.go       # 市场数据处理器
│   │   │   ├── trade.go        # 交易处理器
│   │   │   └── account.go      # 账户处理器
│   │   ├── middleware/
│   │   │   ├── auth.go         # 认证中间件
│   │   │   ├── ratelimit.go    # 限流中间件
│   │   │   └── logger.go       # 日志中间件
│   │   └── router.go           # 路由配置
│   │
│   ├── ws/                     # WebSocket
│   │   ├── hub.go              # 连接管理中心
│   │   ├── client.go           # 客户端连接
│   │   ├── channel/
│   │   │   ├── ticker.go       # Ticker 频道
│   │   │   ├── candle.go       # K线频道
│   │   │   ├── orderbook.go    # 深度频道
│   │   │   ├── trade.go        # 成交频道
│   │   │   ├── position.go     # 持仓频道 (私有)
│   │   │   └── order.go        # 订单频道 (私有)
│   │   └── publisher.go        # 消息发布器
│   │
│   ├── service/                # 业务逻辑层
│   │   ├── market_service.go   # 市场数据服务
│   │   ├── trade_service.go    # 交易服务
│   │   ├── account_service.go  # 账户服务
│   │   ├── position_service.go # 持仓服务
│   │   ├── order_service.go    # 订单服务
│   │   ├── price_service.go    # 价格服务
│   │   └── funding_service.go  # 资金费服务
│   │
│   ├── repository/             # 数据访问层
│   │   ├── user_repo.go
│   │   ├── order_repo.go
│   │   ├── position_repo.go
│   │   ├── candle_repo.go
│   │   └── trade_repo.go
│   │
│   ├── model/                  # 数据模型
│   │   ├── user.go
│   │   ├── order.go
│   │   ├── position.go
│   │   ├── candle.go
│   │   └── trade.go
│   │
│   ├── keeper/                 # Keeper 服务
│   │   ├── liquidator.go       # 清算执行器
│   │   ├── order_executor.go   # 订单执行器
│   │   ├── funding_settler.go  # 资金费结算
│   │   └── price_updater.go    # 价格更新器
│   │
│   └── pkg/                    # 公共包
│       ├── blockchain/         # 链上交互
│       ├── cache/              # 缓存
│       ├── config/             # 配置
│       ├── errors/             # 错误定义
│       └── utils/              # 工具函数
│
├── configs/
│   ├── config.yaml             # 配置文件
│   └── config.example.yaml
│
└── migrations/                  # 数据库迁移
    ├── 001_create_users.sql
    ├── 002_create_orders.sql
    └── ...
```

### 7.3 智能合约模块边界

```
contracts/
│
├── src/
│   ├── core/                    # 核心合约
│   │   ├── Vault.sol           # 资金托管 (BNB)
│   │   ├── PositionManager.sol # 持仓管理
│   │   ├── OrderBook.sol       # 订单簿
│   │   ├── LiquidityPool.sol   # LP 池
│   │   └── FundingRate.sol     # 资金费率
│   │
│   ├── tokens/                  # 代币合约
│   │   ├── MemeToken.sol       # MEME 代币
│   │   └── LPToken.sol         # LP 代币
│   │
│   ├── periphery/               # 外围合约
│   │   ├── Presale.sol         # 内盘认购
│   │   ├── Router.sol          # 交易路由
│   │   ├── AMM.sol             # 自动做市商
│   │   └── PriceOracle.sol     # 价格预言机
│   │
│   ├── keepers/                 # Keeper 合约
│   │   ├── Liquidator.sol      # 清算器
│   │   └── OrderExecutor.sol   # 订单执行器
│   │
│   └── interfaces/              # 接口定义
│       ├── IVault.sol
│       ├── IPositionManager.sol
│       ├── ILiquidityPool.sol
│       └── ...
│
├── test/                        # 测试
│   ├── Vault.t.sol
│   ├── PositionManager.t.sol
│   └── ...
│
├── script/                      # 部署脚本
│   ├── Deploy.s.sol
│   └── Upgrade.s.sol
│
├── foundry.toml
└── remappings.txt
```

### 7.4 模块通信规则

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          模块通信规则                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  前端 ──────────────────────────────────────────────────────> 后端      │
│       │                                                        │        │
│       │  HTTP: /api/v1/*                                       │        │
│       │  WebSocket: /ws/v1/public, /ws/v1/private              │        │
│       │                                                        │        │
│       │  ❌ 禁止前端直接调用合约进行交易操作                     │        │
│       │  ✅ 允许前端直接调用合约: 充值、提现、认购               │        │
│                                                                         │
│  后端 ──────────────────────────────────────────────────────> 区块链    │
│       │                                                        │        │
│       │  Keeper 服务调用合约:                                   │        │
│       │  • 执行清算                                            │        │
│       │  • 执行限价单                                          │        │
│       │  • 结算资金费率                                        │        │
│       │                                                        │        │
│       │  Indexer 服务监听事件:                                  │        │
│       │  • 交易事件 -> 更新K线/成交                            │        │
│       │  • 持仓事件 -> 更新持仓                                │        │
│       │  • 清算事件 -> 记录清算                                │        │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     数据一致性保证                              │   │
│  │                                                                 │   │
│  │  • 链上数据 = 权威数据源                                        │   │
│  │  • 后端数据库 = 链上数据的索引和缓存                            │   │
│  │  • 前端状态 = 后端数据的实时镜像                                │   │
│  │                                                                 │   │
│  │  数据流向: 区块链 -> Indexer -> 数据库 -> WebSocket -> 前端     │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 附录: 检查清单

### A. 功能完整性检查

| 模块 | 功能 | HTTP | WebSocket | 合约 | 状态 |
|------|------|------|-----------|------|------|
| 内盘 | 查看认购信息 | GET /presale/info | - | - | |
| 内盘 | 认购 MEME | - | - | subscribe() | |
| 内盘 | 退款 | - | - | refund() | |
| 内盘 | 领取代币 | - | - | claim() | |
| 现货 | 买入 | - | - | swapBNBForMeme() | |
| 现货 | 卖出 | - | - | swapMemeForBNB() | |
| 合约 | 开仓 | POST /trade/order | orders | | |
| 合约 | 平仓 | POST /trade/close | positions | | |
| 合约 | 设置止盈止损 | POST /trade/order-algo | orders-algo | | |
| 合约 | 查看持仓 | GET /account/positions | positions | | |
| 合约 | 被清算 | - | positions, liquidation | | |
| 行情 | 实时价格 | - | tickers | | |
| 行情 | K线 | GET (历史) | candles (实时) | | |
| 行情 | 深度 | - | books | | |
| LP | 存入 | - | - | deposit() | |
| LP | 赎回 | - | - | withdraw() | |
| LP | 领取收益 | - | - | claimRewards() | |

### B. 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2025-01-19 | 初版 - 系统架构文档 |
