# okb.fun 永续合约机制设计文档

> **版本**: v1.0
> **日期**: 2025-01
> **定位**: Meme 全生命周期博弈平台（The Meme Arena）

---

## 目录

1. [核心创新：桥接流动性模型](#1-核心创新桥接流动性模型)
2. [双层架构](#2-双层架构)
3. [四道防线风控体系](#3-四道防线风控体系)
4. [ADL 自动减仓机制](#4-adl-自动减仓机制)
5. [参数配置表](#5-参数配置表)
6. [生命周期：从啃老到分家](#6-生命周期从啃老到分家)
7. [压力测试结果](#7-压力测试结果)

---

## 1. 核心创新：桥接流动性模型

### 1.1 解决的问题

传统 Meme 发射平台（如 pump.fun）的痛点：

| 问题 | 描述 |
|------|------|
| 单边博弈 | 用户只能做多（买现货），无法做空 |
| 庄家优势 | 庄家低成本拿筹码，拉盘砸盘散户无法反制 |
| 等待漫长 | 需等毕业转 DEX 才有流动性 |

### 1.2 我们的解决方案

**创建 Token 即可同时交易现货 + 永续合约**

```
┌─────────────────────────────────────────────────────────────────┐
│                     okb.fun 流动性架构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   现货池 (真实资金)              合约池 (虚拟资金)               │
│   ┌───────────────┐            ┌───────────────┐               │
│   │  Bonding Curve │◄─────────│   vAMM        │               │
│   │  TVL: 真实ETH  │  信用额度  │  借款上限:20% │               │
│   │               │  (借/还)   │               │               │
│   └───────────────┘            └───────────────┘               │
│          ▲                            │                        │
│          │                            │                        │
│          └────── 吸血费率 ────────────┘                        │
│                (合约持仓费 → 现货池)                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**核心机制：信用额度模式**

- 合约池没有独立资金
- 拥有现货池的"信用额度"（最高20%）
- vAMM 代表现货池充当对手盘
- 合约盈利 → 从现货池借钱赔付
- 合约亏损 → 资金注入现货池

---

## 2. 双层架构

### 2.1 现货层 (Spot Layer)

| 属性 | 值 |
|------|-----|
| 机制 | Bonding Curve (x * y = k) |
| 资金 | 真实 ETH，平台唯一 TVL 来源 |
| 虚拟池 | 初始 1 ETH（低进入门槛） |
| 作用 | 定价基准 + 合约层的借贷方 |
| 毕业条件 | TVL 达到 50 ETH |

### 2.2 合约层 (Contract Layer)

| 属性 | 值 |
|------|-----|
| 机制 | vAMM (虚拟自动做市商) |
| 资金 | 借用现货池的信用额度 |
| 杠杆 | 最高 50x |
| 标记价格 | 现货 5 分钟 TWAP |
| 资金费率 | 吸血费率（流向现货池） |

---

## 3. 四道防线风控体系

### 3.1 第一道：动态滑点（劝退）

**目的**：单边拥挤时增加开仓成本，劝退投机者

**公式**：
```
slippage = BASE_SLIPPAGE × (1 + netExposure / creditLimit)³

其中：
- BASE_SLIPPAGE = 0.1%
- netExposure = |多头持仓 - 空头持仓|
- creditLimit = 信用额度
```

**示例**：
| 资金使用率 | 滑点 |
|-----------|------|
| 0% | 0.1% |
| 50% | 0.34% |
| 75% | 0.86% |
| 90% | 1.73% |

**方向性**：
- 开仓方向与净敞口同向 → 滑点 × 2
- 开仓方向与净敞口反向 → 滑点 × 0.5（鼓励对冲）

### 3.2 第二道：吸血费率（消耗）

**目的**：持续消耗单边持仓者，为现货池"输血"

**公式（拐点模型）**：
```
if (utilization <= 50%):
    rate = 0.01% + utilization × 0.02%
else:
    rate = 1% × e^(8 × (utilization - 50%))
```

**示例**：
| 资金使用率 | 费率/小时 | 费率/天 |
|-----------|----------|---------|
| 10% | 0.03% | 0.72% |
| 50% | 1.0% | 24% |
| 70% | 5.5% | 132% |
| 90% | 54.6% | 1310% |
| 100% | 148% | 3552% |

**特点**：
- 费率不是支付给对手盘，而是**支付给现货池**
- 拐点后指数级增长，形成"绞肉机"效果

### 3.3 第三道：熔断（禁止）

**目的**：硬性限制，防止超出信用额度

**规则**：
```
净敞口 ≥ 信用额度 × 100% → 禁止加剧方向的新开仓
```

**用户体验**：
```
错误信息: "CIRCUIT_BREAKER: Long position limit reached"
建议: "当前多头拥挤，请等待或尝试开空"
```

### 3.4 第四道：ADL 自动减仓（强平）

**目的**：最后防线，强制平仓保护现货池

详见 [第4章](#4-adl-自动减仓机制)

---

## 4. ADL 自动减仓机制

### 4.1 触发条件

```
总未实现盈利 ≥ 信用额度 × 70%
```

### 4.2 强平优先级

**ADL 优先级分数**：
```
priority = (盈利 / 保证金) × 60% + (仓位 / 保证金) × 40%
```

| 优先级 | 类型 | 原因 |
|--------|------|------|
| 高 | 盈利最大 | 占用额度最多，已经赚到了 |
| 高 | 保证金最少（高杠杆） | 风险最高，容易爆仓 |

### 4.3 执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        ADL 执行流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 检测触发条件（总浮盈 ≥ 70%）                                 │
│                    ↓                                            │
│  2. 等待 1 个区块（防闪电贷）                                    │
│                    ↓                                            │
│  3. 再次确认仍需 ADL                                            │
│                    ↓                                            │
│  4. 计算所有盈利仓位的优先级                                     │
│                    ↓                                            │
│  5. 按优先级从高到低强平                                         │
│                    ↓                                            │
│  6. 直到总浮盈 < 60%（目标阈值）                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.4 被 ADL 用户结算

**公式**：
```
返还金额 = 保证金 + 盈利 × 赔付比例
赔付比例 = min(1, 可用额度 / 总浮盈)
```

**示例**：
```
信用额度 = 2 ETH
总浮盈 = 2.8 ETH (触发 ADL)
可用额度 = 2 × 70% = 1.4 ETH
赔付比例 = 1.4 / 2.8 = 50%

用户A: 保证金 0.1 ETH, 浮盈 1 ETH
被ADL后获得 = 0.1 + 1 × 50% = 0.6 ETH
```

### 4.5 分阶段处理

| 阶段 | 浮盈/额度 | 行为 |
|------|----------|------|
| 正常 | < 60% | 正常运行 |
| 警告 | 60%-70% | 前端显示 ADL 风险提示 |
| 触发 | ≥ 70% | 执行 ADL 强平 |
| 紧急 | ≥ 90% | 暂停新开仓 + 加速强平 |

### 4.6 公平性保障

1. **分档强平**：不是一次性全平，分批处理
2. **部分平仓**：尽量只平必要的部分
3. **时间保护**：等待 1 区块防止闪电贷攻击
4. **TWAP 定价**：使用标记价格避免瞬时操控

---

## 5. 参数配置表

### 5.1 核心参数

| 参数 | 值 | 类型 | 说明 |
|------|-----|------|------|
| GRADUATION_THRESHOLD | 50 ETH | 固定值 | 毕业标准 |
| MAX_CREDIT_RATIO | 20% | 动态递减 | 初始信用额度比例 |
| INSURANCE_FUND_THRESHOLD | 10 ETH | 固定值 | 分家条件 |
| MAX_LEVERAGE | 50x | 固定值 | 最大杠杆 |
| TWAP_WINDOW | 5 minutes | 固定值 | 标记价格时间窗口 |

### 5.2 滑点参数

| 参数 | 值 | 说明 |
|------|-----|------|
| BASE_SLIPPAGE | 0.1% (10 bps) | 基础滑点 |
| SLIPPAGE_EXPONENT | 3 | 立方增长 |
| SAME_DIRECTION_MULTIPLIER | 2x | 同向开仓倍数 |

### 5.3 费率参数

| 参数 | 值 | 说明 |
|------|-----|------|
| BASE_RATE | 0.01%/h | 基础费率 |
| KINK_UTILIZATION | 50% | 拐点位置 |
| KINK_RATE | 1%/h | 拐点费率 |
| EXPONENTIAL_FACTOR | 8 | 指数系数 |
| MAX_RATE | 200%/h | 费率上限 |

### 5.4 ADL 参数

| 参数 | 值 | 说明 |
|------|-----|------|
| ADL_TRIGGER_THRESHOLD | 70% | 触发阈值 |
| ADL_TARGET_THRESHOLD | 60% | 目标阈值 |
| PROFIT_WEIGHT | 60% | 盈利率权重 |
| LEVERAGE_WEIGHT | 40% | 杠杆率权重 |
| CONFIRMATION_BLOCKS | 1 | 确认区块数 |

---

## 6. 生命周期：从啃老到分家

### 6.1 啃老期（初期）

```
TVL: 0 → 50 ETH
信用额度: 20% → 0%（动态递减）
合约池: 依赖现货池信用额度
```

**信用额度递减公式**：
```
creditRatio = MAX_CREDIT × (1 - TVL / GRADUATION_THRESHOLD)

TVL = 0 ETH   → 20%
TVL = 25 ETH  → 10%
TVL = 45 ETH  → 2%
TVL = 50 ETH  → 0%
```

### 6.2 毕业条件

```
TVL ≥ 50 ETH
AND
保险基金 ≥ 10 ETH
```

### 6.3 分家期（毕业后）

```
现货池: 迁移到 DEX (Uniswap/PancakeSwap)
合约池: 独立运营，使用自己的保险基金
信用额度: 切断，物理隔离
```

### 6.4 生命周期图示

```
┌─────────────────────────────────────────────────────────────────┐
│                      Token 生命周期                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  创建 Token                                                      │
│      ↓                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  啃老期 (0-50 ETH)                                       │   │
│  │  - 现货: Bonding Curve 交易                              │   │
│  │  - 合约: 借用现货池信用额度                              │   │
│  │  - 风控: 四道防线全开                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│      ↓ TVL ≥ 50 ETH && 保险基金 ≥ 10 ETH                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  毕业 & 分家                                             │   │
│  │  - 现货: 迁移到 DEX                                      │   │
│  │  - 合约: 独立运营                                        │   │
│  │  - 信用额度: 切断                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│      ↓                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  独立期                                                  │   │
│  │  - 现货: DEX 流动性池                                    │   │
│  │  - 合约: 自负盈亏，用保险基金                            │   │
│  │  - 标记价格: DEX TWAP 或 Chainlink                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 压力测试结果

### 7.1 测试场景

```
初始状态:
- 现货池 TVL = 10 ETH
- 信用额度 = 2 ETH (20%)
- Token 价格 = $0.001

极端事件:
- 10 分钟内价格暴涨 50 倍
- 所有合约用户都做多（全是多头）
```

### 7.2 时间线

| 时间 | 事件 | 使用率 | 费率/h | 备注 |
|------|------|--------|--------|------|
| T=0 | 初始状态 | 0% | 0.01% | - |
| T=1min | 首批开多 0.5 ETH | 25% | 0.5% | 正常 |
| T=3min | 继续开多，总 1.5 ETH | 75% | 8% | 滑点增加 |
| T=5min | 逼近上限 1.8 ETH | 90% | 54.6% | 费率激增 |
| T=6min | 触发熔断 | 100% | 148% | 禁止开多 |
| T=7min | ADL 触发 | - | - | 强制平仓 |
| T=10min | 稳定 | <60% | - | 恢复正常 |

### 7.3 损益分析

```
┌─────────────────────────────────────────────────────────┐
│           现货池 10分钟损益表（最坏情况）                 │
├─────────────────────────────────────────────────────────┤
│ 最大潜在损失（信用额度上限）    -2.00 ETH               │
│ 吸血费率收入                    +0.15 ETH               │
│ 动态滑点收入                    +0.10 ETH               │
├─────────────────────────────────────────────────────────┤
│ 净最大损失                      -1.75 ETH               │
│ 占 TVL 比例                     17.5%                   │
│                                                         │
│ ✅ 控制在 20% 安全线以内                                │
└─────────────────────────────────────────────────────────┘
```

### 7.4 不同场景结果

| 场景 | 现货池影响 | 说明 |
|------|-----------|------|
| 正常博弈（使用率<50%） | +收益 | 费率+滑点收租 |
| 单边拥挤（使用率50-80%） | +收益 | 高费率覆盖风险 |
| 极端行情（使用率>80%） | -5~15% TVL | 熔断+ADL保护 |
| 50倍暴涨全做多 | -15~20% TVL | 最坏情况，仍可控 |

---

## 附录 A：与竞品对比

| 特性 | pump.fun | GMX | okb.fun |
|------|----------|-----|---------|
| 现货交易 | ✅ | ❌ | ✅ |
| 永续合约 | ❌ | ✅ | ✅ |
| 做空能力 | ❌ | ✅ | ✅ |
| 冷启动流动性 | 虚拟池 | 需要LP | 借用现货 |
| 早期博弈 | 单边 | 需流动性 | 双边 |
| Meme 友好 | ✅ | ❌ | ✅ |

---

## 附录 B：术语表

| 术语 | 英文 | 解释 |
|------|------|------|
| 信用额度 | Credit Line | 合约池可从现货池借用的最大金额 |
| 吸血费率 | Vampire Funding Rate | 流向现货池的资金费率 |
| 熔断 | Circuit Breaker | 禁止特定方向开仓的机制 |
| ADL | Auto-Deleveraging | 自动减仓，强制平仓盈利仓位 |
| 毕业 | Graduation | TVL达标，迁移到DEX |
| 分家 | Separation | 合约池独立，切断信用额度 |
| vAMM | Virtual AMM | 虚拟自动做市商 |
| TWAP | Time-Weighted Average Price | 时间加权平均价格 |

---

## 附录 C：更新日志

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-01 | 初始版本 |

---

*本文档由 okb.fun 技术团队编写*
